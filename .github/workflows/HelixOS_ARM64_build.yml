name: HelixOS CMake builder

on:
  push:
    branches: [ "v0.0.1-dev" ]
  pull_request:
    branches: [ "v0.0.1-dev" ]

env:
  BUILD_TYPE: Debug

  # HelixOS variables in workflow to bypass direnv
  HELIX_SOURCE_DIR:   ${{github.workspace}}
  HELIX_BINARY_DIR:   ${{github.workspace}}/build
  HELIX_EXT_DIR:      ${{github.workspace}}/external
  HELIX_SCRIPTS_DIR:  ${{github.workspace}}/scripts
  HELIX_SYSROOT:      ${{github.workspace}}/build/sysroot
  HELIX_PREFIX:       ${{github.workspace}}/build/sysroot/usr


jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Init submodules
      run: |
        git submodule sync --recursive
        git submodule update --init --recursive --remote


    - name: Export HelixOS variables
      run: |
        export HELIX_SOURCE_DIR=${{env.HELIX_SCRIPTS_DIR}}
        export HELIX_BINARY_DIR=${{env.HELIX_BINARY_DIR}}
        export HELIX_EXT_DIR=${{env.HELIX_EXT_DIR}}
        export HELIX_SCRIPTS_DIR=${{env.HELIX_SCRIPTS_DIR}}
        export HELIX_SYSROOT=${{env.HELIX_SYSROOT}}
        export HELIX_PREFIX=${{env.HELIX_PREFIX}}

    - name: Init external
      run: |
        git submodule sync --recursive
        git submodule update --init --recursive --depth=1

    - name: Install deps
      run: |  
        sudo apt-get update 
        sudo apt-get install gcc-aarch64-linux-gnu cmake mtools gdisk qemu-system-aarch64 direnv

    - name: Configure HelixOS
      run: |
        cmake -S ${{github.workspace}} -B ${{github.workspace}}/build

    - name: Build HelixOS
      run: |
        cmake --build ${{github.workspace}}/build
